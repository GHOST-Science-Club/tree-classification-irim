name: Tests and Coverage Deployment

on:
    pull_request:

jobs:
#    mypy-tests:
#        runs-on: ${{ matrix.os }}
#        strategy:
#            matrix:
#                os: [ ubuntu-latest, windows-latest ]
#                python-version: [ '3.10', '3.11' ]
#
#        steps:
#            -   uses: actions/checkout@v3
#            -   name: Set up Python ${{ matrix.python-version }}
#                uses: actions/setup-python@v4
#                with:
#                    python-version: ${{ matrix.python-version }}
#            -   name: Install dependencies
#                run: |
#                    python -m pip install --upgrade pip
#                    pip install tox tox-gh-actions
#            -   name: Run TOX mypy
#                run: tox -e mypy

    flake8-tests:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest ]
                python-version: [ '3.10', '3.11' ]

        steps:
            -   uses: actions/checkout@v3
            -   name: Set up Python ${{ matrix.python-version }}
                uses: actions/setup-python@v4
                with:
                    python-version: ${{ matrix.python-version }}
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install tox tox-gh-actions
            -   name: Run TOX flake8
                run: tox -e flake8

    pytest:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest ]
                python-version: [ '3.10', '3.11' ]

        steps:
            -   uses: actions/checkout@v3
            -   name: Set up Python ${{ matrix.python-version }}
                uses: actions/setup-python@v4
                with:
                    python-version: ${{ matrix.python-version }}
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install tox tox-gh-actions
            -   name: Run TOX tests
                run: tox
                env:
                    PLATFORM: ${{ matrix.os }}
            # -   name: Save Coverage Report
            #     run: |
            #         mkdir -p coverage_reports/${{ matrix.os }}-${{ matrix.python-version }}
            #         cp -r ./htmlcov/* coverage_reports/${{ matrix.os }}-${{ matrix.python-version }}/
            
            # -   name: Upload Partial Coverage Reports
            #     uses: actions/upload-artifact@v4
            #     with:
            #         name: test-coverage-reports
            #         path: coverage_reports/
    coverage:
        runs-on: ubuntu-latest
        needs: pytest
        steps:
            -   uses: actions/checkout@v3
            -   name: Set up Python
                uses: actions/setup-python@v4
                with:
                    python-version: 3.11
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install pytest pytest-cov
            -   name: Generate test coverage
                run: pytest --cov=src --cov-report=html
            -   name: Upload artifacts
                uses: actions/upload-pages-artifact@v3
                with:
                   path: ./htmlcov

    deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: coverage
        steps:
            # -   name: Get First File
            #     run: echo "FIRST_FILE=$(find coverage_reports -type f | head -n 1)" >> $GITHUB_ENV
            # -   name: Upload First File
            #     uses: actions/upload-artifact@v4
            #     with:
            #         name: first-coverage-file
            #         path: ${{ env.FIRST_FILE }}
            -   name: Deploy to GitHub Pages
                id: deployment
                uses: actions/deploy-pages@v4